# 処理フロー概要

> 下記の図は、サーバープログラムとクライアントプログラムの全体的な処理フローをまとめたものです。サーバー側ではUDPサーバーとTCPサーバーを起動し、クライアント側ではTCPを用いて初期の接続・ルーム作成／参加を行った後、UDPを用いて実際のチャットを行う構成になっています。また、サーバー側では定期的に非アクティブクライアントを検知し、キックやルーム削除を行う仕組みを備えています。

---

## 1. サーバー起動処理

1. **メインスレッド**  
   - サーバープログラムを起動すると、まずメインスレッドが走り始めます。  
   - ここでTCPサーバーとUDPサーバーの2種類のサーバーを起動し、それぞれを別スレッドで動かす準備をします。

2. **TCPサーバースレッドの開始**  
   - メインスレッドから呼び出され、`TCPServer` インスタンスを生成して `start_tcp_server()` を実行します。  
   - TCPサーバースレッドはクライアントからの「ルーム作成」または「ルーム参加」のリクエストを受け付ける役割を担います。  
   - クライアント接続受付後、操作コードに応じてルームを作成したり、すでに存在するルームへ参加させたりして、トークンを発行します。

3. **UDPサーバースレッドの開始**  
   - 同様にメインスレッドから `UDPServer` インスタンスを生成し、`start_udp_server()` を呼び出すことでUDPサーバースレッドが走ります。  
   - UDPサーバースレッドでは、チャットのメッセージ処理とクライアントの監視（非アクティブクライアントの自動切断）を並行して行います。  
   - スレッドを二つ用意し、1つ目のスレッドで「チャットメッセージの受信とブロードキャスト」、2つ目のスレッドで「非アクティブクライアントの検知・キック」を実装しています。

---

## 2. クライアント起動処理

1. **クライアント実行**  
   - クライアントプログラムを起動すると、まず `TCPClient` によるサーバー（TCP）への接続を試みます。  
   - 接続が完了すると、ユーザーにユーザー名や操作内容（新規ルーム作成か既存ルーム参加か）を入力させます。

2. **TCPクライアント開始**  
   - `TCPClient` が入力情報（ユーザー名や「1: ルーム作成」「2: ルーム参加」）をもとに、サーバーにパケットを送信します。  
   - 「1: ルーム作成」の場合はルーム名を入力して新しいルームを作成し、サーバーからトークンを受け取ります。  
   - 「2: ルーム参加」の場合はサーバーから既存ルーム一覧を受信し、その中から参加したいルームを選択・送信して、参加用のトークンを受け取ります。

3. **UDPクライアント開始**  
   - TCPでルーム作成または参加が完了し、トークンを受け取った後、TCPのソケットはいったんクローズされます。  
   - 続いて `UDPClient` を起動し、サーバー（UDP）へ参加通知を送信してチャットをスタートします。  
   - ここでは入力メッセージをUDPで送信し、受信したメッセージをコンソールに表示し続けます。

---

## 3. メッセージ処理 & 監視（UDP サーバー）

1. **クライアントからのメッセージ受信**  
   - `UDPServer` は常時 `handle_messages()` でクライアントからのメッセージを受信します。  
   - パケットを解析して「どのルームか」「どのクライアントトークンか」「メッセージ本文」を取得し、必要に応じてログを出力します。

2. **ルーム内ブロードキャスト**  
   - 同じルームに所属しているメンバー（トークン）をルーム管理テーブルから検索し、送信元以外のすべてのクライアントへメッセージをブロードキャストします。

3. **非アクティブクライアントの監視**  
   - `remove_inactive_clients()` スレッドで定期的にクライアントの最終アクティブ時刻をチェックします。  
   - 一定時間（プログラムでは 100 秒）アクティブが確認できないクライアントは「タイムアウト」として処理され、強制的にキック（切断）されます。  
   - ホスト（ルーム作成者）の場合は、ルーム自体を削除し、参加していた他のクライアントにも「ホストがいなくなった」旨を通知します。

---

## 4. クライアント終了処理

1. **サーバー側からの通知による切断**  
   - サーバーからのタイムアウト通知を受信したクライアントは、UDPで「exit」を送信して自発的に切断したり、ソケットを閉じたりします。  
   - ホストが退出した場合はルームごと削除されるため、参加していたメンバーへも「exit!」がブロードキャストされます。

2. **ユーザー手動での切断**  
   - クライアント側のユーザーが「exit」と入力すると、UDPでサーバーに「exit」を送信して退出を実行し、ソケットを閉じます。  
   - サーバーは、ホストだった場合はルーム削除を行い、ゲストの場合は該当ルームからそのトークンを削除します。

---

## まとめ

- **サーバープログラム**  
  - **TCPサーバー** : クライアントのルーム作成・参加受付とトークン発行  
  - **UDPサーバー** : チャットメッセージのやり取りとクライアント監視  

- **クライアントプログラム**  
  - **TCPクライアント** : ルームの作成または参加を行い、サーバーからトークンを受け取る  
  - **UDPクライアント** : 実際のチャット通信とサーバーからのメッセージ受信  

- **非アクティブクライアントの管理**  
  - サーバー側で定期的に最後のアクティブ時間を監視し、長時間反応のないクライアントを自動で切断・ルームから除去

このように、TCP でルーム管理を行った後、UDP でチャット本体を運用するハイブリッド構成をとることで、シンプルなチャットアプリケーション機能を実現しています。
