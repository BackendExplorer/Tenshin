### プロトコルのバイト表

| フィールド             | バイト数    | 説明                       |
|--------------------|-----------|--------------------------|
| **RoomNameSize**    | 1 バイト   | ルーム名のバイト数               |
| **Operation**       | 1 バイト   | 操作コード (Operation)          |
| **State**           | 1 バイト   | ステートコード (State)          |
| **OperationPayloadSize** | 29 バイト  | 操作ペイロードのサイズ            |
| **RoomName**        | RoomNameSize バイト | ルーム名 (最大28バイト)           |
| **OperationPayload**| OperationPayloadSize バイト | 操作ペイロード (最大229バイト)    |

#### メモ:
- RoomNameSize は 1 バイトで、最大 28 バイトのルーム名の長さを示します。
- OperationPayloadSize は 29 バイトで、最大 229 バイトのペイロードのサイズを示します。















## 📦 バイトの情報

---

### 🧩 RoomNameSize

| データ名   | 内容                     |
|------------|--------------------------|
| **説明**   | ルームの許容人数         |
| **バイト数** | 1バイト                 |
| **型**     | `byte_int(0–255)`        |

---

### ⚙️ Operation

| データ名   | 内容                     |
|------------|--------------------------|
| **説明**   | 操作コードのこと         |
| **状態1**  | ルームを作成する         |
| **状態2**  | ルームに参加したい       |
| **バイト数** | 1バイト                 |
| **型**     | `byte_int(0–255)`        |

---

### 🔄 State

| データ名   | 内容                                  |
|------------|---------------------------------------|
| **説明**   | 現在の状態のこと                      |
| **状態0**  | サーバの初期化（ルーム作成要求）      |
| **状態1**  | リクエストの応答（ルーム作成中）      |
| **状態2**  | リクエストの完了（ルーム作成完了）     |
| **バイト数** | 1バイト                             |
| **型**     | `byte_int(0–255)`                    |

---

### 📏 OperationPayloadSize

| データ名   | 内容                                                        |
|------------|-------------------------------------------------------------|
| **説明**   | データ本体のこと                                            |
| **内容**   | `RoomName`（8バイト） + `OperationPayload`（21バイト）     |
| **バイト数** | 29バイト                                                   |
| **型**     | `byte_str`                                                 |













## バイトの情報

---

### RoomNameSize

| データ名 | RoomNameSize |
|----------|----------------|
| 説明     | ルームの許容人数 |
| バイト数 | 1バイト         |
| 型       | byte_int(0–255) |

---

### Operation

| データ名 | Operation      |
|----------|----------------|
| 説明     | 操作コードのこと |
| 状態1    | ルームを作成する |
| 状態2    | ルームに参加したい |
| バイト数 | 1バイト         |
| 型       | byte_int(0–255) |

---

### State

| データ名 | State           |
|----------|------------------|
| 説明     | 現在の状態のこと   |
| 状態0    | サーバの初期化（ルーム作成要求） |
| 状態1    | リクエストの応答（ルーム作成中） |
| 状態2    | リクエストの完了（ルーム作成完了） |
| バイト数 | 1バイト           |
| 型       | byte_int(0–255)   |

---

### OperationPayloadSize

| データ名 | OperationPayloadSize            |
|----------|----------------------------------|
| 説明     | データ本体のこと                   |
| 内容     | RoomName(8バイト) + OperationPayload(21バイト) |
| バイト数 | 29バイト                          |
| 型       | byte_str                          |















```mermaid
flowchart TD
    Start([スタート])
    入力[ユーザー名を入力]
    選択[作成または参加を選択]

    作成1[「作成」を選択]
    ルーム名入力[ルーム名を入力]

    参加2[「参加」を選択]
    ルーム一覧[ルーム一覧から選択]

    チャット中[チャット中]
    End([終了])

    Start --> 入力 --> 選択

    選択 --> 作成1 --> ルーム名入力 --> チャット中
    選択 --> 参加2 --> ルーム一覧 --> チャット中

    チャット中 --> End

```





```mermaid
graph TD

%% スタイル定義
classDef server fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px
classDef client fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
classDef messaging fill:#ede7f6,stroke:#6a1b9a,stroke-width:2px
classDef warning fill:#ffebee,stroke:#c62828,stroke-width:2px

%% サーバー起動
subgraph サーバー起動[サーバー起動処理]
A1(メインスレッド)
A2(TCPサーバースレッド)
A3(UDPサーバースレッド)
A4(クライアント接続受理)
A5(クライアント登録)
A6(メッセージスレッド)
A7(監視スレッド)

A1 -->|TCPサーバーを開始| A2
A1 -->|UDPサーバーを開始| A3
A2 -->|クライアント待機| A4
A4 -->|ルーム作成/参加| A5
A3 -->|メッセージ処理開始| A6
A3 -->|非アクティブ監視開始| A7

class A1,A2,A3,A4,A5,A6,A7 server
end

%% クライアント起動
subgraph クライアント起動[クライアント起動処理]
B1(クライアント実行)
B2(TCPクライアント開始)
B3(接続成功)
B4(ユーザー名入力)
B5(ルーム作成または参加)
B6(ルーム作成処理)
B7(トークン受信)
B8(ルーム参加処理)
B9(トークン受信)
B10(UDPクライアント開始)
B11(チャット開始)

B1 --> B2
B2 --> B3
B3 --> B4
B4 --> B5
B5 -->|ルーム作成| B6 --> B7
B5 -->|ルーム参加| B8 --> B9
B2 --> B10
B10 --> B11

class B1,B2,B3,B4,B5,B6,B7,B8,B9,B10,B11 client
end

%% サーバーメッセージ処理
subgraph サーバーメッセージ処理[メッセージ処理＆監視]
C1(UDPサーバー)
C2(クライアントからメッセージ受信)
C3(ルームへブロードキャスト)
C4(非アクティブチェック)
C5(キック＆ルーム管理)

C1 --> C2 --> C3
C1 --> C4 -->|タイムアウト| C5

class C1,C2,C3,C4,C5 messaging
end

%% クライアント終了
subgraph クライアント終了[クライアント終了処理]
D1(クライアント)
D2(UDPで'exit!'送信)
D3(ソケットを閉じる)
D4(タイムアウト通知受信)
D5(ルーム削除または通知)

D1 -->|ユーザーがexitと入力| D2 --> D3
D1 -->|サーバーから通知| D4 --> D5

class D1,D2,D3,D4,D5 warning
end

%% 流れ接続（全体の連携）
A1 --> B1
B1 --> C1
C1 --> D1
```


```mermaid
sequenceDiagram
    actor ユーザー
    participant TCPクライアント as TCPクライアント(Python)
    participant TCPサーバ as TCPサーバ
    participant UDPクライアント as UDPクライアント(Python)
    participant UDPサーバ as UDPサーバ

    ユーザー->>TCPクライアント: ① Pythonクライアントプログラムを起動
    TCPクライアント->>TCPサーバ: ② 接続要求 (TCP)
    TCPサーバ-->>TCPクライアント: ③ 接続成功通知

    ユーザー->>TCPクライアント: ④ ユーザー名を入力
    ユーザー->>TCPクライアント: ⑤ 1または2を入力 (1: ルーム作成, 2: ルーム参加)

    alt 1(ルーム作成)を選択
        TCPクライアント->>TCPサーバ: ⑥ ルーム作成要求(ルーム名, ユーザー名)
        TCPサーバ-->>TCPクライアント: ⑦ ルーム作成完了 & トークン返却
    else 2(ルーム参加)を選択
        TCPクライアント->>TCPサーバ: ⑥ ルーム参加要求(ユーザー名)
        TCPサーバ-->>TCPクライアント: ⑦ 既存ルーム一覧を返却
        ユーザー->>TCPクライアント: ⑧ 参加したいルーム名を入力
        TCPクライアント->>TCPサーバ: ⑨ 選択したルーム名を送信
        TCPサーバ-->>TCPクライアント: ⑩ トークン返却
    end

    note over TCPクライアント: ルーム名とトークンを取得
    
    TCPクライアント->>UDPクライアント: ⑪ ルーム名・ユーザー名・トークンを渡す

    ユーザー->>UDPクライアント: ⑫ チャット開始
    UDPクライアント->>UDPサーバ: ⑬ メッセージ送信 (UDP)
    UDPサーバ-->>UDPクライアント: ⑭ メッセージ受信

    note over UDPサーバ: ルーム内の他メンバーへブロードキャスト

    UDPサーバ-->>UDPクライアント: ⑮ 他ユーザーからのメッセージ
    ユーザー->>UDPクライアント: ⑯ メッセージ入力を続ける
    loop 継続
        UDPクライアント->>UDPサーバ: メッセージ送信
        UDPサーバ-->>UDPクライアント: ブロードキャストメッセージ受信
    end
```


